"use strict";const F=require("react"),g=require("./shared-BGRnP8D5.js"),M=require("./shared-BvhuVP2H.js"),f=require("livekit-client");function ge(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const r=ge(F),Q=r.createContext(void 0);function Ce(){const e=r.useContext(Q);if(!e)throw Error("tried to access session context outside of SessionProvider component");return e}function Y(){return r.useContext(Q)}function ae(e){const t=Y(),n=e??t;if(!n)throw new Error("No session provided, make sure you are inside a Session context or pass the session explicitly");return n}function Se(e){const t=g.useEnsureRoom(e),n=r.useCallback(async()=>{await t.startAudio()},[t]),i=r.useMemo(()=>g.roomAudioPlaybackAllowedObservable(t),[t]),{canPlayAudio:d}=M.useObservableState(i,{canPlayAudio:t.canPlaybackAudio});return{canPlayAudio:d,startAudio:n}}function Te(e){const{state:t,dispatch:n}=M.useLayoutContext().pin;return{buttonProps:r.useMemo(()=>{const{className:d}=g.setupClearPinButton();return M.mergeProps(e,{className:d,disabled:!(t!=null&&t.length),onClick:()=>{n&&n({msg:"clear_pin"})}})},[e,n,t])}}function Ee(e,t){const n=typeof e=="function"?e:t,i=typeof e=="string"?e:void 0,d=g.useRoomContext(),{send:c,messageObservable:s,isSendingObservable:p}=r.useMemo(()=>g.setupDataMessageHandler(d,i,n),[d,i,n]),T=M.useObservableState(s,void 0),b=M.useObservableState(p,!1);return{message:T,send:c,isSending:b}}const ke={connect:!0,audio:!1,video:!1};function ye(e){const{token:t,serverUrl:n,options:i,room:d,connectOptions:c,connect:s,audio:p,video:T,screen:b,onConnected:E,onDisconnected:a,onError:h,onMediaDeviceFailure:k,onEncryptionError:P,simulateParticipants:L,...x}={...ke,...e};i&&d&&g.log.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[R,N]=r.useState(),_=r.useRef(s);r.useEffect(()=>{N(d??new f.Room(i))},[d,JSON.stringify(i,M.roomOptionsStringifyReplacer)]);const u=r.useMemo(()=>{const{className:o}=g.setupLiveKitRoom();return M.mergeProps(x,{className:o})},[x]);return r.useEffect(()=>{if(!R)return;const o=()=>{const m=R.localParticipant;g.log.debug("trying to publish local tracks"),Promise.all([m.setMicrophoneEnabled(!!p,typeof p!="boolean"?p:void 0),m.setCameraEnabled(!!T,typeof T!="boolean"?T:void 0),m.setScreenShareEnabled(!!b,typeof b!="boolean"?b:void 0)]).catch(A=>{g.log.warn(A),h==null||h(A)})},l=(m,A)=>{const I=f.MediaDeviceFailure.getFailure(m);k==null||k(I,A)},v=m=>{P==null||P(m)},S=m=>{a==null||a(m)},y=()=>{E==null||E()};return R.on(f.RoomEvent.SignalConnected,o).on(f.RoomEvent.MediaDevicesError,l).on(f.RoomEvent.EncryptionError,v).on(f.RoomEvent.Disconnected,S).on(f.RoomEvent.Connected,y),()=>{R.off(f.RoomEvent.SignalConnected,o).off(f.RoomEvent.MediaDevicesError,l).off(f.RoomEvent.EncryptionError,v).off(f.RoomEvent.Disconnected,S).off(f.RoomEvent.Connected,y)}},[R,p,T,b,h,P,k,E,a]),r.useEffect(()=>{if(R){if(L){R.simulateParticipants({participants:{count:L},publish:{audio:!0,useRealTracks:!0}});return}if(s){if(_.current=!0,g.log.debug("connecting"),!t){g.log.debug("no token yet");return}if(!n){g.log.warn("no livekit url provided"),h==null||h(Error("no livekit url provided"));return}R.connect(n,t,c).catch(o=>{g.log.warn(o),_.current===!0&&(h==null||h(o))})}else g.log.debug("disconnecting because connect is false"),_.current=!1,R.disconnect()}},[s,t,JSON.stringify(c),R,h,n,L]),r.useEffect(()=>{if(R)return()=>{g.log.info("disconnecting on onmount"),R.disconnect()}},[R]),{room:R,htmlProps:u}}function we(e={}){let t=M.useMaybeParticipantContext();e.participant&&(t=e.participant);const n=r.useMemo(()=>g.participantInfoObserver(t),[t]),{identity:i,name:d,metadata:c}=M.useObservableState(n,{name:t==null?void 0:t.name,identity:t==null?void 0:t.identity,metadata:t==null?void 0:t.metadata});return{identity:i,name:d,metadata:c}}function Pe(e={}){const t=M.useEnsureParticipant(e.participant),n=r.useMemo(()=>g.participantPermissionObserver(t),[t]);return M.useObservableState(n,t.permissions)}function V(e={}){const t=g.useEnsureRoom(e.room),[n,i]=r.useState([]);return r.useEffect(()=>{const d=g.connectedParticipantsObserver(t,{additionalRoomEvents:e.updateOnlyOn}).subscribe(i);return()=>d.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn)]),n}function ue(e={}){const t=V(e),{localParticipant:n}=g.useLocalParticipant(e);return r.useMemo(()=>[n,...t],[n,t])}function Re(e,t={}){const n=g.useRoomContext(),[i]=r.useState(t.updateOnlyOn),d=r.useMemo(()=>typeof e=="string"?g.connectedParticipantObserver(n,e,{additionalEvents:i}):g.participantByIdentifierObserver(n,e,{additionalEvents:i}),[n,JSON.stringify(e),i]),[c,s]=r.useState({p:void 0});return r.useEffect(()=>{const p=d.subscribe(T=>s({p:T}));return()=>p.unsubscribe()},[d]),c.p}function Me(e={}){const t=g.useEnsureRoom(e.room),n=r.useMemo(()=>g.roomInfoObserver(t),[t]),{name:i,metadata:d}=M.useObservableState(n,{name:t.name,metadata:t.metadata});return{name:i,metadata:d}}function le(e){const t=g.useEnsureRoom(e==null?void 0:e.room),n=r.useMemo(()=>g.activeSpeakerObserver(t),[t]);return M.useObservableState(n,t.activeSpeakers)}function Ae(e){const[t,n]=r.useState(g.sortParticipants(e)),i=le();return r.useEffect(()=>{n(g.sortParticipants(e))},[i,e]),t}function Le(e,t,n={}){const[i,d]=r.useState(void 0);return r.useEffect(()=>{var s;if(e===void 0)throw Error("token endpoint needs to be defined");if(((s=n.userInfo)==null?void 0:s.identity)===void 0)return;(async()=>{g.log.debug("fetching token");const p=new URLSearchParams({...n.userInfo,roomName:t}),T=await fetch(`${e}?${p.toString()}`);if(!T.ok){g.log.error(`Could not fetch token. Server responded with status ${T.status}: ${T.statusText}`);return}const{accessToken:b}=await T.json();d(b)})()},[e,t,JSON.stringify(n)]),i}function Oe(e){const[t,n]=r.useState(g.getTrackByIdentifier(e)),{trackObserver:i}=r.useMemo(()=>g.setupMediaTrack(e),[e.participant.sid??e.participant.identity,e.source]);return r.useEffect(()=>{const d=i.subscribe(c=>{n(c)});return()=>d==null?void 0:d.unsubscribe()},[i]),{participant:e.participant,source:e.source??f.Track.Source.Unknown,publication:t}}function xe(e,t){const n=M.useEnsureParticipant(t);return Oe({name:e,participant:n})}function z(e,t={}){let n,i;typeof t=="string"?n=t:(n=t==null?void 0:t.participantIdentity,i=t==null?void 0:t.room);const d=M.useMaybeParticipantContext(),c=ue({room:i,updateOnlyOn:[]}),s=r.useMemo(()=>n?c.find(b=>b.identity===n):d,[n,c,d]),p=r.useMemo(()=>{if(s)return g.participantTracksObservable(s,{sources:e})},[s,JSON.stringify(e)]);return M.useObservableState(p,[])}function De(e){var n,i,d;const t=r.useMemo(()=>{var c;return(c=e==null?void 0:e.publication)!=null&&c.track?g.trackSyncTimeObserver(e==null?void 0:e.publication.track):void 0},[(n=e==null?void 0:e.publication)==null?void 0:n.track]);return M.useObservableState(t,{timestamp:Date.now(),rtpTimestamp:(d=(i=e==null?void 0:e.publication)==null?void 0:i.track)==null?void 0:d.rtpTimestamp})}const _e={bufferSize:100};function fe(e,t){const n={..._e,...t},[i,d]=r.useState([]),c=De(e),s=p=>{var T;(T=n.onTranscription)==null||T.call(n,p),d(b=>g.dedupeSegments(b,p.map(E=>g.addMediaTimestampToTranscription(E,c)),n.bufferSize))};return r.useEffect(()=>{if(!(e!=null&&e.publication))return;const p=g.trackTranscriptionObserver(e.publication).subscribe(T=>{s(...T)});return()=>{p.unsubscribe()}},[e&&g.getTrackReferenceId(e),s]),{segments:i}}function de(e={}){const t=M.useMaybeParticipantContext(),n=e.participant??t,i=r.useMemo(()=>g.participantAttributesObserver(n),[n]);return M.useObservableState(i,{attributes:n==null?void 0:n.attributes})}function Ne(e,t={}){const n=M.useEnsureParticipant(t.participant),[i,d]=r.useState(n.attributes[e]);return r.useEffect(()=>{if(!n)return;const c=g.participantAttributesObserver(n).subscribe(s=>{s.changed[e]!==void 0&&d(s.attributes[e])});return()=>{c.unsubscribe()}},[n,e]),i}const ne=g.ParticipantAgentAttributes.AgentState;function Ie(){const e=V(),t=e.find(a=>a.kind===f.ParticipantKind.AGENT&&!(g.ParticipantAgentAttributes.PublishOnBehalf in a.attributes)),n=e.find(a=>a.kind===f.ParticipantKind.AGENT&&a.attributes[g.ParticipantAgentAttributes.PublishOnBehalf]===(t==null?void 0:t.identity)),i=z([f.Track.Source.Microphone,f.Track.Source.Camera],t==null?void 0:t.identity),d=z([f.Track.Source.Microphone,f.Track.Source.Camera],n==null?void 0:n.identity),c=i.find(a=>a.source===f.Track.Source.Microphone)??d.find(a=>a.source===f.Track.Source.Microphone),s=i.find(a=>a.source===f.Track.Source.Camera)??d.find(a=>a.source===f.Track.Source.Camera),{segments:p}=fe(c),T=M.useConnectionState(),{attributes:b}=de({participant:t}),E=r.useMemo(()=>T===f.ConnectionState.Disconnected?"disconnected":T===f.ConnectionState.Connecting||!t||!(b!=null&&b[ne])?"connecting":b[ne],[b,t,T]);return{agent:t,state:E,audioTrack:c,videoTrack:s,agentTranscriptions:p,agentAttributes:b}}function Ue(e){const t=g.useEnsureRoom(e),n=M.useConnectionState(t),i=r.useMemo(()=>g.recordingStatusObservable(t),[t,n]);return M.useObservableState(i,t.isRecording)}function pe(e,t){const n=g.useEnsureRoom(t==null?void 0:t.room),d=M.useConnectionState(n)===f.ConnectionState.Disconnected,c=r.useMemo(()=>g.setupTextStream(n,e),[n,e]),s=d?void 0:c;return{textStreams:M.useObservableState(s,[])}}function me(e){const{participantIdentities:t,trackSids:n}=e??{},{textStreams:i}=pe(g.DataTopic.TRANSCRIPTION,{room:e==null?void 0:e.room});return r.useMemo(()=>i.filter(c=>t?t.includes(c.participantInfo.identity):!0).filter(c=>{var s;return n?n.includes(((s=c.streamInfo.attributes)==null?void 0:s[g.ParticipantAgentAttributes.TranscribedTrackId])??""):!0}),[i,t,n])}const re=2,oe=400,se=3,ie=1e3;function Fe(e){const t=F.useRef([]),n=F.useMemo(()=>new f.Mutex,[]),i=F.useCallback(async()=>n.lock().then(async E=>{for(;;){const a=t.current.pop();if(!a){E();break}switch(a.type){case"connect":await a.room.connect(...a.args).then(a.resolve).catch(a.reject);break;case"disconnect":await a.room.disconnect(...a.args).then(a.resolve).catch(a.reject);break}}}),[]),d=F.useRef([]),c=F.useCallback(E=>{let a=0;d.current=d.current.filter(h=>{const k=E.getTime()-h.getTime()<ie;return k&&(a+=1),k}),a>se&&g.log.warn(`useSequentialRoomConnectDisconnect: room changed reference rapidly (over ${se}x in ${ie}ms). This is not recommended.`)},[]);F.useEffect(()=>{t.current=[];const E=new Date;d.current.push(E),c(E)},[e,c]);const s=F.useRef([]),p=F.useCallback(E=>{let a=0;s.current=s.current.filter(h=>{const k=E.getTime()-h.getTime()<oe;return k&&(a+=1),k}),a>re&&g.log.warn(`useSequentialRoomConnectDisconnect: room connect / disconnect occurring in rapid sequence (over ${re}x in ${oe}ms). This is not recommended and may be the sign of a bug like a useEffect dependency changing every render.`)},[]),T=F.useCallback(async(...E)=>new Promise((a,h)=>{if(!e)throw new Error("Called connect(), but room was unset");const k=new Date;p(k),t.current.push({type:"connect",room:e,args:E,resolve:a,reject:h}),s.current.push(k),i()}),[e,p,i]),b=F.useCallback(async(...E)=>new Promise((a,h)=>{if(!e)throw new Error("Called discconnect(), but room was unset");const k=new Date;p(k),t.current.push({type:"disconnect",room:e,args:E,resolve:a,reject:h}),s.current.push(k),i()}),[e,p,i]);return{connect:e?T:null,disconnect:e?b:null}}var J={exports:{}},ce;function je(){if(ce)return J.exports;ce=1;var e=typeof Reflect=="object"?Reflect:null,t=e&&typeof e.apply=="function"?e.apply:function(o,l,v){return Function.prototype.apply.call(o,l,v)},n;e&&typeof e.ownKeys=="function"?n=e.ownKeys:Object.getOwnPropertySymbols?n=function(o){return Object.getOwnPropertyNames(o).concat(Object.getOwnPropertySymbols(o))}:n=function(o){return Object.getOwnPropertyNames(o)};function i(u){console&&console.warn&&console.warn(u)}var d=Number.isNaN||function(o){return o!==o};function c(){c.init.call(this)}J.exports=c,J.exports.once=R,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var s=10;function p(u){if(typeof u!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof u)}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(u){if(typeof u!="number"||u<0||d(u))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+u+".");s=u}}),c.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(o){if(typeof o!="number"||o<0||d(o))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+o+".");return this._maxListeners=o,this};function T(u){return u._maxListeners===void 0?c.defaultMaxListeners:u._maxListeners}c.prototype.getMaxListeners=function(){return T(this)},c.prototype.emit=function(o){for(var l=[],v=1;v<arguments.length;v++)l.push(arguments[v]);var S=o==="error",y=this._events;if(y!==void 0)S=S&&y.error===void 0;else if(!S)return!1;if(S){var m;if(l.length>0&&(m=l[0]),m instanceof Error)throw m;var A=new Error("Unhandled error."+(m?" ("+m.message+")":""));throw A.context=m,A}var I=y[o];if(I===void 0)return!1;if(typeof I=="function")t(I,this,l);else for(var j=I.length,H=P(I,j),v=0;v<j;++v)t(H[v],this,l);return!0};function b(u,o,l,v){var S,y,m;if(p(l),y=u._events,y===void 0?(y=u._events=Object.create(null),u._eventsCount=0):(y.newListener!==void 0&&(u.emit("newListener",o,l.listener?l.listener:l),y=u._events),m=y[o]),m===void 0)m=y[o]=l,++u._eventsCount;else if(typeof m=="function"?m=y[o]=v?[l,m]:[m,l]:v?m.unshift(l):m.push(l),S=T(u),S>0&&m.length>S&&!m.warned){m.warned=!0;var A=new Error("Possible EventEmitter memory leak detected. "+m.length+" "+String(o)+" listeners added. Use emitter.setMaxListeners() to increase limit");A.name="MaxListenersExceededWarning",A.emitter=u,A.type=o,A.count=m.length,i(A)}return u}c.prototype.addListener=function(o,l){return b(this,o,l,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(o,l){return b(this,o,l,!0)};function E(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function a(u,o,l){var v={fired:!1,wrapFn:void 0,target:u,type:o,listener:l},S=E.bind(v);return S.listener=l,v.wrapFn=S,S}c.prototype.once=function(o,l){return p(l),this.on(o,a(this,o,l)),this},c.prototype.prependOnceListener=function(o,l){return p(l),this.prependListener(o,a(this,o,l)),this},c.prototype.removeListener=function(o,l){var v,S,y,m,A;if(p(l),S=this._events,S===void 0)return this;if(v=S[o],v===void 0)return this;if(v===l||v.listener===l)--this._eventsCount===0?this._events=Object.create(null):(delete S[o],S.removeListener&&this.emit("removeListener",o,v.listener||l));else if(typeof v!="function"){for(y=-1,m=v.length-1;m>=0;m--)if(v[m]===l||v[m].listener===l){A=v[m].listener,y=m;break}if(y<0)return this;y===0?v.shift():L(v,y),v.length===1&&(S[o]=v[0]),S.removeListener!==void 0&&this.emit("removeListener",o,A||l)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(o){var l,v,S;if(v=this._events,v===void 0)return this;if(v.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):v[o]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete v[o]),this;if(arguments.length===0){var y=Object.keys(v),m;for(S=0;S<y.length;++S)m=y[S],m!=="removeListener"&&this.removeAllListeners(m);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(l=v[o],typeof l=="function")this.removeListener(o,l);else if(l!==void 0)for(S=l.length-1;S>=0;S--)this.removeListener(o,l[S]);return this};function h(u,o,l){var v=u._events;if(v===void 0)return[];var S=v[o];return S===void 0?[]:typeof S=="function"?l?[S.listener||S]:[S]:l?x(S):P(S,S.length)}c.prototype.listeners=function(o){return h(this,o,!0)},c.prototype.rawListeners=function(o){return h(this,o,!1)},c.listenerCount=function(u,o){return typeof u.listenerCount=="function"?u.listenerCount(o):k.call(u,o)},c.prototype.listenerCount=k;function k(u){var o=this._events;if(o!==void 0){var l=o[u];if(typeof l=="function")return 1;if(l!==void 0)return l.length}return 0}c.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function P(u,o){for(var l=new Array(o),v=0;v<o;++v)l[v]=u[v];return l}function L(u,o){for(;o+1<u.length;o++)u[o]=u[o+1];u.pop()}function x(u){for(var o=new Array(u.length),l=0;l<o.length;++l)o[l]=u[l].listener||u[l];return o}function R(u,o){return new Promise(function(l,v){function S(m){u.removeListener(o,y),v(m)}function y(){typeof u.removeListener=="function"&&u.removeListener("error",S),l([].slice.call(arguments))}_(u,o,y,{once:!0}),o!=="error"&&N(u,S,{once:!0})})}function N(u,o,l){typeof u.on=="function"&&_(u,"error",o,l)}function _(u,o,l,v){if(typeof u.on=="function")v.once?u.once(o,l):u.on(o,l);else if(typeof u.addEventListener=="function")u.addEventListener(o,function S(y){v.once&&u.removeEventListener(o,S),l(y)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof u)}return J.exports}var X=je();const He=2e4;var he=(e=>(e.CameraChanged="cameraChanged",e.MicrophoneChanged="microphoneChanged",e.StateChanged="stateChanged",e))(he||{});const U=e=>({isConnected:e==="listening"||e==="thinking"||e==="speaking",canListen:e==="pre-connect-buffering"||e==="listening"||e==="thinking"||e==="speaking",isFinished:e==="disconnected"||e==="failed",isPending:e==="connecting"||e==="initializing"||e==="idle"}),Be=()=>{const[e,t]=r.useState(null),[n,i]=r.useState(null),d=r.useRef("connecting"),c=r.useRef(!1),s=p=>setTimeout(()=>{if(!c.current){t("Agent did not join the room.");return}const{isConnected:T}=U(d.current);if(!T){t("Agent joined the room but did not complete initializing.");return}},p??He);return{agentTimeoutFailureReason:e,startAgentTimeout:r.useCallback(p=>{n&&clearTimeout(n),t(null),i(s(p)),d.current="connecting",c.current=!1},[n]),clearAgentTimeout:r.useCallback(()=>{n&&clearTimeout(n),t(null),i(null),d.current="connecting",c.current=!1},[n]),updateAgentTimeoutState:r.useCallback(p=>{d.current=p},[]),updateAgentTimeoutParticipantExists:r.useCallback(p=>{c.current=p},[])}};function We(e,t){const n=r.useRef(t);r.useEffect(()=>{n.current=t},[t]);const i=r.useCallback(async s=>{const{isConnected:p}=U(n.current);if(!p)return new Promise((T,b)=>{const E=k=>{const{isConnected:P}=U(k);P&&(h(),T())},a=()=>{h(),b(new Error("useAgent(/* ... */).waitUntilConnected - signal aborted"))},h=()=>{e.off("stateChanged",E),s==null||s.removeEventListener("abort",a)};e.on("stateChanged",E),s==null||s.addEventListener("abort",a)})},[e]),d=r.useCallback(async s=>{const{canListen:p}=U(n.current);if(!p)return new Promise((T,b)=>{const E=k=>{const{canListen:P}=U(k);P&&(h(),T())},a=()=>{h(),b(new Error("useAgent(/* ... */).waitUntilCouldBeListening - signal aborted"))},h=()=>{e.off("stateChanged",E),s==null||s.removeEventListener("abort",a)};e.on("stateChanged",E),s==null||s.addEventListener("abort",a)})},[e]),c=r.useCallback(async s=>{const{isFinished:p}=U(n.current);if(!p)return new Promise((T,b)=>{const E=k=>{const{isFinished:P}=U(k);P&&(h(),T())},a=()=>{h(),b(new Error("useAgent(/* ... */).waitUntilFinished - signal aborted"))},h=()=>{e.off("stateChanged",E),s==null||s.removeEventListener("abort",a)};e.on("stateChanged",E),s==null||s.addEventListener("abort",a)})},[e]);return{waitUntilConnected:i,waitUntilCouldBeListening:d,waitUntilFinished:c}}function Z(e){const t=Y();if(e=e??t,!e)throw new Error("No session provided, make sure you are inside a Session context or pass the session explicitly");const{room:n,internal:{agentConnectTimeoutMilliseconds:i,agentTimeoutFailureReason:d,startAgentTimeout:c,clearAgentTimeout:s,updateAgentTimeoutState:p,updateAgentTimeoutParticipantExists:T}}=e,b=r.useMemo(()=>new X.EventEmitter,[]),E=V({room:n}),a=r.useMemo(()=>E.find(C=>C.kind===f.ParticipantKind.AGENT&&!(g.ParticipantAgentAttributes.PublishOnBehalf in C.attributes))??null,[E]),h=r.useMemo(()=>a?E.find(C=>C.kind===f.ParticipantKind.AGENT&&C.attributes[g.ParticipantAgentAttributes.PublishOnBehalf]===a.identity)??null:null,[a,E]),[k,P]=r.useState({});r.useEffect(()=>{if(!a)return;const C=D=>{P(D)};return a.on(f.ParticipantEvent.AttributesChanged,C),()=>{a.off(f.ParticipantEvent.AttributesChanged,C)}},[a,b]);const L=z([f.Track.Source.Camera,f.Track.Source.Microphone],{room:n,participantIdentity:a==null?void 0:a.identity}),x=z([f.Track.Source.Camera,f.Track.Source.Microphone],{room:n,participantIdentity:h==null?void 0:h.identity}),R=r.useMemo(()=>L.find(C=>C.source===f.Track.Source.Camera)??x.find(C=>C.source===f.Track.Source.Camera),[L,x]);r.useEffect(()=>{b.emit("cameraChanged",R)},[b,R]);const N=r.useMemo(()=>L.find(C=>C.source===f.Track.Source.Microphone)??x.find(C=>C.source===f.Track.Source.Microphone),[L,x]);r.useEffect(()=>{b.emit("microphoneChanged",N)},[b,N]);const[_,u]=r.useState(n.state);r.useEffect(()=>{const C=D=>{u(D)};return n.on(f.RoomEvent.ConnectionStateChanged,C),()=>{n.off(f.RoomEvent.ConnectionStateChanged,C)}},[n]);const[o,l]=r.useState(null);r.useEffect(()=>{if(!a)return;const C=D=>{D.identity===(a==null?void 0:a.identity)&&l("Agent left the room unexpectedly.")};return n.on(f.RoomEvent.ParticipantDisconnected,C),()=>{n.off(f.RoomEvent.ParticipantDisconnected,C)}},[a,n]),r.useEffect(()=>{_===f.ConnectionState.Disconnected&&l(null)},[_]);const[v,S]=r.useState(()=>n.localParticipant.getTrackPublication(f.Track.Source.Microphone)??null);r.useEffect(()=>{const C=()=>{S(n.localParticipant.getTrackPublication(f.Track.Source.Microphone)??null)},D=()=>{S(null)};return n.localParticipant.on(f.ParticipantEvent.LocalTrackPublished,C),n.localParticipant.on(f.ParticipantEvent.LocalTrackUnpublished,D),()=>{n.localParticipant.off(f.ParticipantEvent.LocalTrackPublished,C),n.localParticipant.off(f.ParticipantEvent.LocalTrackUnpublished,D)}},[n.localParticipant]);const y=r.useMemo(()=>{const C=[];return d&&C.push(d),o&&C.push(o),C},[d,o]),m=r.useMemo(()=>{if(y.length>0)return"failed";let C="disconnected";return _!==f.ConnectionState.Disconnected&&(C="connecting"),v&&(C="pre-connect-buffering"),a&&k[g.ParticipantAgentAttributes.AgentState]&&(C=k[g.ParticipantAgentAttributes.AgentState]),C},[y,_,v,a,k]);r.useEffect(()=>{b.emit("stateChanged",m),p(m)},[b,m]),r.useEffect(()=>{T(a!==null)},[a]);const A=e.connectionState==="disconnected";r.useEffect(()=>{if(!A)return c(i),()=>{s()}},[A,i]);const I=r.useMemo(()=>{const C={attributes:k,internal:{agentParticipant:a,workerParticipant:h,emitter:b}};switch(m){case"disconnected":return{...C,state:m,...U(m),failureReasons:null,cameraTrack:void 0,microphoneTrack:void 0};case"connecting":return{...C,state:m,...U(m),failureReasons:null,cameraTrack:void 0,microphoneTrack:void 0};case"initializing":case"idle":return{...C,state:m,...U(m),failureReasons:null,cameraTrack:R,microphoneTrack:N};case"pre-connect-buffering":return{...C,state:m,...U(m),failureReasons:null,cameraTrack:R,microphoneTrack:N};case"listening":case"thinking":case"speaking":return{...C,state:m,...U(m),failureReasons:null,cameraTrack:R,microphoneTrack:N};case"failed":return{...C,state:"failed",...U("failed"),failureReasons:y,cameraTrack:void 0,microphoneTrack:void 0}}},[k,b,a,m,R,N]),{waitUntilConnected:j,waitUntilCouldBeListening:H,waitUntilFinished:w}=We(b,m),O=r.useCallback(C=>new Promise((D,K)=>{const B=q=>{q&&(G(),D(q))},W=()=>{G(),K(new Error("useAgent(/* ... */).waitUntilCamera - signal aborted"))},G=()=>{b.off("cameraChanged",B),C==null||C.removeEventListener("abort",W)};b.on("cameraChanged",B),C==null||C.addEventListener("abort",W)}),[b]),$=r.useCallback(C=>new Promise((D,K)=>{const B=q=>{q&&(G(),D(q))},W=()=>{G(),K(new Error("useAgent(/* ... */).waitUntilMicrophone - signal aborted"))},G=()=>{b.off("microphoneChanged",B),C==null||C.removeEventListener("abort",W)};b.on("microphoneChanged",B),C==null||C.addEventListener("abort",W)}),[b]);return r.useMemo(()=>({...I,waitUntilConnected:j,waitUntilCouldBeListening:H,waitUntilFinished:w,waitUntilCamera:O,waitUntilMicrophone:$}),[I,j,H,w,O,$])}var ve=(e=>(e.ConnectionStateChanged="connectionStateChanged",e.MediaDevicesError="mediaDevicesError",e.EncryptionError="encryptionError",e))(ve||{});function qe(e,t){const n=new Set([...Object.keys(e),...Object.keys(t)]);for(const i of n)switch(i){case"roomName":case"participantName":case"participantIdentity":case"participantMetadata":case"participantAttributes":case"agentName":case"agentMetadata":if(e[i]!==t[i])return!1;break;default:const d=i;throw new Error(`Options key ${d} not being checked for equality!`)}return!0}function Ge(e,t){const n=r.useRef(t);return r.useEffect(()=>{n.current=t},[t]),r.useCallback(async(d,c)=>{if(n.current!==d)return new Promise((s,p)=>{const T=a=>{a===d&&(E(),s())},b=()=>{E(),p(new Error(`useSession(/* ... */).waitUntilConnectionState(${d}, /* signal */) - signal aborted`))},E=()=>{e.off("connectionStateChanged",T),c==null||c.removeEventListener("abort",b)};e.on("connectionStateChanged",T),c==null||c.addEventListener("abort",b)})},[e])}function Ke(e,t){const n=e instanceof f.TokenSourceConfigurable,i=r.useRef(n?t:null);return r.useEffect(()=>{if(!n){i.current=null;return}i.current!==null&&qe(i.current,t)||(i.current=t)},[n,t]),r.useCallback(async()=>{if(n){if(!i.current)throw new Error("AgentSession - memoized token fetch options are not set, but the passed tokenSource was an instance of TokenSourceConfigurable. If you are seeing this please make a new GitHub issue!");return e.fetch(i.current)}else return e.fetch()},[n,e])}function $e(e,t={}){const{room:n,agentConnectTimeoutMilliseconds:i,...d}=t,c=g.useMaybeRoomContext(),s=r.useMemo(()=>c??n??new f.Room,[c,n]),p=r.useMemo(()=>new X.EventEmitter,[]),T=r.useCallback(w=>({isConnected:w===f.ConnectionState.Connected||w===f.ConnectionState.Reconnecting||w===f.ConnectionState.SignalReconnecting}),[]),[b,E]=r.useState(s.state);r.useEffect(()=>{const w=O=>{E(O)};return s.on(f.RoomEvent.ConnectionStateChanged,w),()=>{s.off(f.RoomEvent.ConnectionStateChanged,w)}},[s]),r.useEffect(()=>{const w=async O=>{p.emit("mediaDevicesError",O)};return s.on(f.RoomEvent.MediaDevicesError,w),()=>{s.off(f.RoomEvent.MediaDevicesError,w)}},[s,p]),r.useEffect(()=>{const w=async O=>{p.emit("encryptionError",O)};return s.on(f.RoomEvent.EncryptionError,w),()=>{s.off(f.RoomEvent.EncryptionError,w)}},[s,p]);const{localParticipant:a}=g.useLocalParticipant({room:s}),h=a.getTrackPublication(f.Track.Source.Camera),k=r.useMemo(()=>!h||h.isMuted?null:{source:f.Track.Source.Camera,participant:a,publication:h},[a,h,h==null?void 0:h.isMuted]),P=a.getTrackPublication(f.Track.Source.Microphone),L=r.useMemo(()=>!P||P.isMuted?null:{source:f.Track.Source.Microphone,participant:a,publication:P},[a,P,P==null?void 0:P.isMuted]),{agentTimeoutFailureReason:x,startAgentTimeout:R,clearAgentTimeout:N,updateAgentTimeoutState:_,updateAgentTimeoutParticipantExists:u}=Be(),o=r.useMemo(()=>({emitter:p,tokenSource:e,agentConnectTimeoutMilliseconds:i,agentTimeoutFailureReason:x,startAgentTimeout:R,clearAgentTimeout:N,updateAgentTimeoutState:_,updateAgentTimeoutParticipantExists:u}),[p,i,e,x,R,N,_,u]),l=r.useMemo(()=>{const w={room:s,internal:o};switch(b){case f.ConnectionState.Connecting:return{...w,connectionState:f.ConnectionState.Connecting,...T(f.ConnectionState.Connecting),local:{cameraTrack:null,microphoneTrack:null}};case f.ConnectionState.Connected:case f.ConnectionState.Reconnecting:case f.ConnectionState.SignalReconnecting:return{...w,connectionState:b,...T(b),local:{cameraTrack:k,microphoneTrack:L}};case f.ConnectionState.Disconnected:return{...w,connectionState:f.ConnectionState.Disconnected,...T(f.ConnectionState.Disconnected),local:{cameraTrack:null,microphoneTrack:null}}}},[o,s,b,k,L,T]);r.useEffect(()=>{p.emit("connectionStateChanged",l.connectionState)},[p,l.connectionState]);const v=Ge(p,l.connectionState),S=r.useCallback(async w=>v(f.ConnectionState.Connected,w),[v]),y=r.useCallback(async w=>v(f.ConnectionState.Disconnected,w),[v]),m=Z(r.useMemo(()=>({connectionState:l.connectionState,room:s,internal:o}),[l,s,o])),A=Ke(e,d),I=r.useCallback(async(w={})=>{var B,W;const{signal:O,tracks:$={microphone:{enabled:!0,publishOptions:{preConnectBuffer:!0}}},roomConnectOptions:C}=w;await y(O);const D=()=>{s.disconnect()};O==null||O.addEventListener("abort",D);let K=!1;await Promise.all([A().then(({serverUrl:G,participantToken:q})=>{var ee,te;return K=(((te=(ee=f.decodeTokenPayload(q).roomConfig)==null?void 0:ee.agents)==null?void 0:te.length)??0)>0,s.connect(G,q,C)}),(B=$.microphone)!=null&&B.enabled?s.localParticipant.setMicrophoneEnabled(!0,void 0,((W=$.microphone)==null?void 0:W.publishOptions)??{}):Promise.resolve()]),await S(O),K&&await m.waitUntilConnected(O),O==null||O.removeEventListener("abort",D)},[s,y,A,S,m.waitUntilConnected]),j=r.useCallback(async()=>{await s.disconnect()},[s]),H=r.useCallback(async()=>{const w=await A();await s.prepareConnection(w.serverUrl,w.participantToken)},[A,s]);return r.useEffect(()=>{H().catch(w=>{console.warn("WARNING: Room.prepareConnection failed:",w)})},[]),r.useMemo(()=>({...l,waitUntilConnected:S,waitUntilDisconnected:y,prepareConnection:H,start:I,end:j}),[l,S,y,H,I,j])}function ze(e,t,n,i){const d=r.useMemo(()=>()=>{},[]),c=r.useCallback(n??d,i??[]),s=i?c:n,p=r.useMemo(()=>e?"internal"in e?e.internal.emitter:e:null,[e]);r.useEffect(()=>{if(!(!p||!s))return p.on(t,s),()=>{p.off(t,s)}},[p,t,s])}var be=(e=>(e.MessageReceived="messageReceived",e))(be||{});function Je(e){const{room:t}=ae(e),n=r.useMemo(()=>new X.EventEmitter,[]),i=Z(e),d=me({room:t}),c=r.useMemo(()=>({room:t}),[t]),s=M.useChat(c),p=r.useMemo(()=>d.map(h=>{var k,P,L;switch(h.participantInfo.identity){case t.localParticipant.identity:return{type:"userTranscript",message:h.text,id:h.streamInfo.id,timestamp:h.streamInfo.timestamp,from:t.localParticipant};case((k=i.internal.agentParticipant)==null?void 0:k.identity):case((P=i.internal.workerParticipant)==null?void 0:P.identity):return{type:"agentTranscript",message:h.text,id:h.streamInfo.id,timestamp:h.streamInfo.timestamp,from:((L=i.internal.agentParticipant)==null?void 0:L.identity)===h.participantInfo.identity?i.internal.agentParticipant:i.internal.workerParticipant};default:return{type:"agentTranscript",message:h.text,id:h.streamInfo.id,timestamp:h.streamInfo.timestamp,from:Array.from(t.remoteParticipants.values()).find(x=>x.identity===h.participantInfo.identity)}}}),[d,t]),T=r.useMemo(()=>[...p,...s.chatMessages],[p,s.chatMessages]),b=r.useRef(new Map),E=r.useMemo(()=>{const h=new Date;for(const k of T)b.current.has(k.id)||b.current.set(k.id,h);return T.sort((k,P)=>{const L=b.current.get(k.id),x=b.current.get(P.id);return typeof L>"u"||typeof x>"u"?0:L.getTime()-x.getTime()})},[T]),a=r.useRef(new Set);return r.useEffect(()=>{for(const h of E)a.current.has(h.id)||(a.current.add(h.id),n.emit("messageReceived",h))},[E]),r.useMemo(()=>({messages:E,send:s.send,isSending:s.isSending,internal:{emitter:n}}),[E,s.send,s.isSending])}exports.AgentEvent=he;exports.MessagesEvent=be;exports.SessionContext=Q;exports.SessionEvent=ve;exports.useAgent=Z;exports.useAudioPlayback=Se;exports.useClearPinButton=Te;exports.useDataChannel=Ee;exports.useEnsureSession=ae;exports.useEvents=ze;exports.useIsRecording=Ue;exports.useLiveKitRoom=ye;exports.useMaybeSessionContext=Y;exports.useParticipantAttribute=Ne;exports.useParticipantAttributes=de;exports.useParticipantInfo=we;exports.useParticipantPermissions=Pe;exports.useParticipantTracks=z;exports.useParticipants=ue;exports.useRemoteParticipant=Re;exports.useRemoteParticipants=V;exports.useRoomInfo=Me;exports.useSequentialRoomConnectDisconnect=Fe;exports.useSession=$e;exports.useSessionContext=Ce;exports.useSessionMessages=Je;exports.useSortedParticipants=Ae;exports.useSpeakingParticipants=le;exports.useTextStream=pe;exports.useToken=Le;exports.useTrackByName=xe;exports.useTrackTranscription=fe;exports.useTranscriptions=me;exports.useVoiceAssistant=Ie;
//# sourceMappingURL=shared-E9DiRD6H.js.map
